<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link href="./home/mystyle.css" rel="stylesheet" />
    
    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
  />
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"
  ></script>
  <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Jua&family=Poor+Story&display=swap');
  </style>
    <script src="./home/api.js" defer></script>
  </head>
  <body>
    <header>
      <div class="mytitle">
        <div class="titleName">
          <h3>ë°˜ë ¤ë™ë¬¼ ì´ì•¼ê¸°</h3>
        </div>
        <div id="weather-container"></div>
        <script src="weather.js"></script>
        <form class="search">
          <select id="search-options">
            <option value="searchNone">ì„ íƒ</option>
            <option value="searchTitle">ì œëª©</option>
            <option value="searchContent">ì œëª©&ë‚´ìš©</option>
            <option value="searchAll">í†µí•©ê²€ìƒ‰</option>
          </select>
          <input id="search-post" placeholder="ë‹¤ì–‘í•œ ê²Œì‹œê¸€ì„ ê²€ìƒ‰í•´ ë³´ì„¸ìš”" />
          <button id="search-btn">ê²€ìƒ‰</button>
        </form>
      </div>
    </header>
    <main>
      <div class="navigator">
        <button type="button"
        class="writePage btn btn-outline-dark"
        onclick="writePage()">ê²Œì‹œê¸€ ì‘ì„±</button>
        <button type="button"
        class="printPosts btn btn-outline-dark"
        onclick="printPosts()">ì „ì²´ ê²Œì‹œê¸€</button>
      </div>
      <div class="modal" id="modal2">
        <div class="form">
          <div>
            <form class="signUpForm" enctype="multipart/form-data">
              <div>
                <div class="input">
                  <label for="signUpEmail">email</label>
                  <input id="signUpEmail" class="modal-input" />
                </div>
                <div class="input">
                  <label for="signUpName">ì´ë¦„</label>
                  <input id="signUpName" class="modal-input" />
                </div>
                <div class="input">
                  <label for="signUpPwd">ë¹„ë°€ë²ˆí˜¸</label>
                  <input id="signUpPwd" class="modal-input" type="password" />
                </div>
                <div class="input">
                  <label for="signUpConfirmPwd">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                  <input id="signUpConfirmPwd" class="modal-input" type="password" />
                </div>
                <div class="input">
                  <label for="signUpPetName">ë°˜ë ¤ë™ë¬¼ëª…</label>
                  <input id="signUpPetName" class="modal-input" />
                </div>
                <div class="signUpImgBox">
                  <input type="file" id="newFile" name="newFile" />
                </div>
              </div>
              <button class="modal-btn btn btn-outline-primary" id="signUpSubmit">íšŒì›ê°€ì…</button>
            </form>
          </div>
          <div>
            <button class="modal-btn btn btn-outline-danger" id="close2" onclick="close2()">ë‹«ê¸°</button>
          </div>
        </div>
      </div>
      <div class="firstBox">
        <div class="userInfoBox">
          <div class="loginForm" id="loginForm">
            <div class="input-group mb-3">
              <span class="input-group-text" id="basic-addon1">email</span>
              <input id="inputEmail" type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text" id="basic-addon1">password</span>
              <input id="inputPWD" type="password" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">
            </div>
            <div>
              <button class="submit btn btn-outline-primary" onclick="sign_in()">ë¡œê·¸ì¸</button>
  
              <button class="signUpModal btn btn-outline-info" onclick="signUpModal()">íšŒì›ê°€ì…</button>
            </div>
          </div>
        </div>
        <div class="postBox">
          <div class="post">
            <p>í™•ì¸ìš©</p>
          </div>
          <div class="post">
            <p>í™•ì¸ìš©</p>
          </div>
          <div class="post">
            <p>í™•ì¸ìš©</p>
          </div>
          <div class="post">
            <p>í™•ì¸ìš©</p>
          </div>
        </div>
      </div>
      <div class="postImgBox">
        <div class="postBottomBox">
          <div class="imgBox"></div>
          <label>í™•ì¸ìš©</label>
        </div>
        <div class="postBottomBox">
          <div class="imgBox"></div>
          <label>í™•ì¸ìš©</label>
        </div>
        <div class="postBottomBox">
          <div class="imgBox"></div>
          <label>í™•ì¸ìš©</label>
        </div>
      </div>
    </main>
    <footer>
      <button id="toggleButton" class="btn btn-outline-warning">ìƒˆ ê°€ì¡±ì„ ì°¾ì•„ë³´ì„¸ìš”!</button>
        <div id="animal-container"></div>
        <script src="./animals.js"></script>
    </footer>
    <script>
      //ëª¨ë‹¬ ì°½ ì—´ê¸°
      function signUpModal() {
        if ($('#modal2').css('display') == 'none') {
          $('#modal2').show();
        }
      }
      function close2() {
        if ($('#modal2').css('display') != 'none') {
          $('#modal2').hide();
        }
      }

      $(document).ready(()=>{
            getPosts();
        })

        //ë¡œê·¸ì¸
      async function sign_in() {
        let email = $('#inputEmail').val();
        let password = $('#inputPWD').val();
        $.ajax({
          type: 'POST',
          url: '/login',
          data: {
            email: email,
            password: password,
          },
          success: function (response) {
            const objString = JSON.stringify(response.userInfo);
            localStorage.setItem('response', objString);
            alert(response.message);
            window.location.replace(`/home/home.html?id=${response.userInfo.User_id}`);
          },
          error: function (error) {
            alert(error.responseJSON.errorMessage);
          },
        });
      }

      //ê²Œì‹œê¸€ ì‘ì„± ë²„íŠ¼
      function writePage() {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      }

      //ì „ì²´ ê²Œì‹œê¸€ ì¡°íšŒ
      function printPosts() {
        window.location.replace(`/post/post.html`);
      }

      //ê²Œì‹œê¸€ get
      function getPosts(){
            $.ajax({
                type: 'GET',
                url: `/posts`,
                error: function (error) {
                    alert(error.responseJSON.errorMessage);
                },
                success: function (response) {
                    const posts = response.posts;
                    
                    let arr = new Array(posts.length);
                    for(let i = 0; i < arr.length; i++){
                        arr[i] = new Array(2);
                    }

                    for(let i in posts){
                        arr[i][0] = posts[i].Likes.length;
                        arr[i][1] = posts[i];
                    }
                    arr.sort((a,b)=>b[0]-a[0]);
                    //titleë§Œ ëœ¨ëŠ”? ë°•ìŠ¤
                    $('.postBox').empty();
                    for(let i = 0; i< 5; i++){                
                        const postInnerHtml = `<div class="post" onclick="postDetail(${arr[i][1].post_id})">
                                                <div>
                                                      <h3 id="postTitle">${arr[i][1].title}</h3>                                                    
                                                      <p id="postLike">${arr[i][1].Name} ğŸ‘${arr[i][0]}</p>
                                                  </div>
                                            </div>`
                        $('.postBox').append(postInnerHtml);
                    }
                    //ë°‘ ì‚¬ì§„ë§Œ ëœ¨ëŠ” ë°•ìŠ¤
                    //ìµœì‹ ìˆœ                    
                    $('.postImgBox').empty();
                    for(let i = 0; i< 5; i++){
                      let img = '';
                      posts[i].image_url ? img = posts[i].image_url : img = '<img src="../image/defaultImage.jpg" class="postImage" alt= />';
                      let date = 'ì‘ì„±ì¼ì: ' + posts[i].created_at.substring(0, 10).replace('-', '.').replace('-', '.');
                      const postInnerHtml = `<div class="postBottomBox" onclick="postDetail(${posts[i].post_id})">
                                              <div class="imgBox">${img}</div>
                                              <p style="text-align:center;">${posts[i].title}</p>
                                              <p style="text-align:center;">ğŸ‘${posts[i].Likes.length}</p>
                                              <p style="text-align:center;">${date}</p>
                                            </div>`
                      $('.postImgBox').append(postInnerHtml);
                    }
                },
            });
        }
        //ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒí˜ì´ì§€ ì´ë™
        function postDetail(post_id){              
            window.location.href =`/detailPost/detailPost.html?postId=${post_id}`;
        }
    </script>
  </body>
</html>
